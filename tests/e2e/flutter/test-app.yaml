# Flutter iOS App E2E Test
# Tests UI hierarchy fetching, interactions, agentLink functionality, and app lifecycle

project: flutter-example
timeout: 30000

steps:
  # 0. Test Deep Link Pairing (simulator)
  - phase: "Test Deep Link Pairing"
  - pair: simulator
    platform: ios
    timeout: 5000

  # 1. Wait for app to be connected and ready
  - phase: "Wait for App Connection"
  - waitFor: increment-button
    timeout: 60000

  # 2. Verify initial UI loaded correctly
  - phase: "Verify Initial UI"
  - assert:
      exists: increment-button

  - assert:
      exists: text-input

  - assert:
      exists: long-press-view

  - assert:
      exists: swipeable-card

  - assert:
      exists: horizontal-scroll

  # 3. Test Tap Interaction (Increment Counter)
  - phase: "Test Tap Interaction"

  - tap: increment-button
    wait: 500

  - waitFor: ""
    logContains: "Counter incremented to 1"
    timeout: 3000

  - assert:
      text:
        testID: counter-value
        equals: "1"

  # Tap again to increment to 2
  - tap: increment-button
    wait: 500

  - waitFor: ""
    logContains: "Counter incremented to 2"
    timeout: 3000

  - assert:
      text:
        testID: counter-value
        equals: "2"

  # 4. Test Input Interaction
  - phase: "Test Input Interaction"
  
  - input: text-input
    value: "Hello from E2E test"

  - waitFor: ""
    logContains: "Hello from E2E test"
    timeout: 3000

  # 5. Test Long Press Interaction
  - phase: "Test Long Press"

  - longPress: long-press-view

  - waitFor: ""
    logContains: "Long pressed"
    timeout: 3000

  # 6. Test AgentLink - Reset State (Example 1)
  - phase: "AgentLink Test - Reset State"

  # Give agentLink handler time to initialize (async in app)
  - sleep: 2000

  - agentLink: "agenteract://reset_state"

  - waitFor: ""
    logContains: "App state cleared"
    timeout: 30000

  # 7. Verify state was reset - counter should be back to 0
  - phase: "Verify State Reset"

  - sleep: 1000

  - assert:
      text:
        testID: counter-value
        equals: "0"

  # 8. Set state again to test multiple reset cycles
  - phase: "Set State Again"

  - tap: increment-button
    wait: 500

  - waitFor: ""
    logContains: "Counter incremented to 1"
    timeout: 3000

  - input: text-input
    value: "Second input"

  - waitFor: ""
    logContains: "Second input"
    timeout: 3000

  - longPress: long-press-view

  - waitFor: ""
    logContains: "Long pressed"
    timeout: 3000

  # 9. Test AgentLink - Reset State Again (Example 2)
  - phase: "AgentLink Test - Second Reset"

  - agentLink: "agenteract://reset_state"

  - waitFor: ""
    logContains: "App state cleared"
    timeout: 30000

  # 10. Verify second reset worked
  - phase: "Verify Second Reset"

  - sleep: 1000

  - assert:
      text:
        testID: counter-value
        equals: "0"

  # 11. Test Scroll Interaction
  - phase: "Test Scroll"

  - scroll: horizontal-scroll
    direction: right
    amount: 100

  - sleep: 500

  # 12. Test Swipe Interaction
  - phase: "Test Swipe"

  - swipe: swipeable-card
    direction: left

  - waitFor: ""
    logContains: "Card swiped"
    timeout: 3000

  # 13. Final state setup before lifecycle test
  - phase: "Setup State Before Lifecycle Test"

  - tap: increment-button
    wait: 500

  - tap: increment-button
    wait: 500

  - tap: increment-button
    wait: 500

  - waitFor: ""
    logContains: "Counter incremented to 3"
    timeout: 3000

  - assert:
      text:
        testID: counter-value
        equals: "3"

  # 14. Test App Lifecycle - Stop App
  # Note: For Flutter, the app is managed by 'agenteract dev'
  # We'll use agentLink to trigger a reset which simulates app state management
  - phase: "Simulate App Lifecycle via AgentLink"

  - agentLink: "agenteract://reset_state"

  - waitFor: ""
    logContains: "App state cleared"
    timeout: 30000

  # 15. Verify app is still responsive and reached initial state
  - phase: "Verify App Responsive After Reset"

  - sleep: 2000

  - waitFor: increment-button
    timeout: 10000

  - assert:
      exists: increment-button

  - assert:
      exists: text-input

  - assert:
      text:
        testID: counter-value
        equals: "0"

  # 16. Test final interaction to confirm app is fully functional
  - phase: "Final Interaction Test"

  - tap: increment-button

  - waitFor: ""
    logContains: "Counter incremented to 1"
    timeout: 3000

  # 17. One more agentLink test for comprehensive coverage
  - phase: "Final AgentLink Test"

  - agentLink: "agenteract://reset_state"

  - waitFor: ""
    logContains: "App state cleared"
    timeout: 30000
